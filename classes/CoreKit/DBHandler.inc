<?php
require_once($_SERVER["DOCUMENT_ROOT"]."/classes/CoreKit/exceptions/Y_DBConnectionException.inc");
require_once($_SERVER["DOCUMENT_ROOT"]."/classes/CoreKit/Singleton.inc");

/**
 *	Klassen DBHandler r Y2-systemets abstraktionslager fr
 *	databashantering. Denna klass ska alltid anvndas nr ett
 *	php-script pratar med databasen.
 *
 *	Klassen r en Singleton-klass, och man nr den globala instansen
 *	genom att anropa metoden getInstance();
 *
 *	@version	Version 		2.2.0\n
 *				Skapad: 		2002-05-15\n
 *				Senast ndrad: 	2005-07-17
 *	@author 	Johan Holmberg, johan@yamborii.net
 */
class DBHandler implements Singleton {
	private static $_instance;
	
	private $_login;   	// Login fr anslutning till MySQL
	private $_pass;    	// Lsen fr anslutning till MySQL
	private $_host;    	// MySQL-serverns placering
	private $_conn;    	// Koppling till MySQL-servern
	private $_database;	// Databasens namn
	private $_data;		// Resultatet frn den senaste frfrgan

	/**
	 *	Skapar ett objekt av DBHandler. Inga parametrar r
	 *	ndvndiga, men gr att ge.\n
	 *	Om inga tidigare instanser skapats av denna klass,
	 *	stts den globala instansen hr.
	 */
	private function __construct() {
		$this->setUp();
	}
	
	/**
	 *	Returnera instansen av DBHandler.
	 *
	 *	@return Singleton-instansen av DBHandler.
	 */
	public static function getInstance() {
       if (!isset(self::$_instance)) {
           $c = __CLASS__;
           self::$_instance = new $c;
       }

       return self::$_instance;
	}
	
	/**
	 *	Stter upp en uppkoppling mot en server.
	 *
	 *	@param $login r ett loginnamn p databasservern.
	 *	@param $pass r ett lsenord p databasservern.
	 *	@param $host r ip-adressen till databasservern.
	 *	@param $database r den databas vi vill arbeta mot.
	 */
	public function setUp($login = '', $pass = '',
						  $host = '', $database = '') {
		global $_YINIT;
		mysql_set_charset('utf8');
		
		if (is_string($login) && strlen($login) > 0) {
			$this->_login = $login;
			$this->_pass = $pass;
			$this->_host = $host;
			$this->_database = $database;
		} else {
			$this->_login = $_YINIT['core_db_login'];
			$this->_pass = $_YINIT['core_db_password'];
			$this->_host = $_YINIT['core_db_host'];
			$this->_database = $_YINIT['core_db_database'];
		}
		$this->_conn = $this->_accessDB();
	}

	/**
	 *	Gr en frfrgan till databasen. Metoden sparar undan giltiga
	 *	resultat lokalt i DBHandler-instansen fr att enklare kunna
	 *	hantera resultatet. Detta r det normala sttet att anvnda
	 *	klassen.\n
	 *	Det gr ven att spara undan resultatet utanfr instansen,
	 *	vilket r lmpligt om man vill arbeta med flera SQL-frgor
	 *	samtidigt. Detta r dock inte att rekommendera, eftersom
	 *	koden d blir mer svrlst.\n
	 *	Kom ihg att kra addslashes() p alla strngar som ska skrivas
	 *	till databasen. Detta fr att frhindra SQL-injektioner.
	 *
	 *	@param	$SQLQuery r en giltig SQL-frga.
	 *
	 *	@return Returnerar \n
	 *			x ett resurs-id om frgan r av typen SELECT, SHOW,
	 *			DESCRIBE, EXPLAIN och giltig\n
	 *			x sant om frgan r av typen INSERT, UPDATE, DELETE
	 *			eller liknande och giltig\n
	 *			x annars falskt.
	 */
	public function runQuery($SQLQuery) {
		$returnResult = false;
		
		if (is_string($SQLQuery) && strlen(trim($SQLQuery)) > 0) {
			unset($this->_data);
			$SQLQuery = trim($SQLQuery);
			$returnResult = mysql_query($SQLQuery, $this->_conn);
			if ($returnResult) {
				$this->_data = $returnResult;
			}
		}
		
		return $returnResult;
	}
      
	/**
	 *	Tar reda p vilket ID-nummer den senast insatta raden fick.
	 *	Om den senaste frgan inte var av INSERT-slaget, returneras
	 *	istllet 0.
	 *
	 *	@return Returnerar ett heltal.
	 */
	public function getID() {
		$id = mysql_insert_id($this->_conn);
		
		return $id;
	}
      
    /**
     *	Ta fram nsta rad frn den senaste databasfrgan. P varje vrde
     *	i den resulterande vektorn kommer stripslashes() att kras.
	 *
	 *	@param	$data r den resurs som returnerades frn runQuery().
	 *			Skickas ingen parameter, anvnds det senaste resultatet.
	 *
	 *	@return Returnerar en vektor innehllandes datan frn en rad ur
	 *			svaret frn en SQL-frga. Om slutet av resultatet r ntt,
	 *			eller om resultatet r tomt, resulteras falskt.
	 */
	public function getRow($data = false) {
		$returnResult = false;
		
		if (is_resource($data)) {
			$returnResult = mysql_fetch_array($data);
		} else if (!$data) {
			$returnResult = mysql_fetch_array($this->_data);
		}
		if ($returnResult) {
			array_map("stripslashes", $returnResult);
		}
		
		return $returnResult;
	}
	
	/**
	 *	Gr om resultatet frn databasfrfrgningen till en
	 *	anvndarbar datastruktur.
	 *
	 *	@param	$data r det heltal som returnerades frn runQuery().
	 *
	 *	@return	Returnerar en vektor av vektorer eller null.
	 */
	public function getRowsAsArray($data = false) {
		$returnResult = null;
		
		if ($data) {
			while ($row = mysql_fetch_array($data)) {
				$returnResult[] =& array_map("stripslashes", $row);
			}
		} else {
			while ($row = mysql_fetch_array($this->_data)) {
				$returnResult[] =& array_map("stripslashes", $row);
			}
		}
		
		return $returnResult;
	}

	/**
	 *	Stnger kopplingen mot servern.
	 */
	public function closeDB() {
		mysql_close();
	}

	/**
	 *	Tar reda p antalet rader som returnerades frn runQuery().
	 *
	 *	@param $data r det heltal som r resultatet frn runQuery().
	 *
	 *	@return Returnerar ett heltal.
	 */
	public function getNbrOfRows($data = false) {
		$returnResult = 0;
		if ($data) {
			if (is_resource($data)) {
				$returnResult = intval(mysql_num_rows($data));
			}
		} else {
			$returnResult = intval(mysql_num_rows($this->_data));
		}
		
		return $returnResult;
	}
	  
	/**
	 *	Tar reda p antalet rader som pverkades av runQuery().
	 *
	 *	@return Returnerar ett heltal.
	 */
	public function getNbrOfAffectedRows() {
		return mysql_affected_rows($this->_conn);
	}
	  
	  ############################################
	 #				Privata funktioner			#
	############################################
	  

	/**
	 *	Skapar en koppling till en MySQL-server.
	 *	@private
	 *
	 *	@throws Kastar ett Y_DBConnectionException om uppkopplingen misslyckades.
	 */
	private function _accessDB(){
		$result = null;    //Den resulterande SQL-kopplingen

		$result = mysql_pconnect($this->_host, $this->_login, $this->_pass);
		mysql_query('SET NAMES utf8');
		if (!$result)
			throw new Y_DBConnectionException("Unable to connect to server.");
		if (!mysql_select_db($this->_database, $result))
			throw new Y_DBConnectionException("Unable to connect to server.");

		return $result;
	}
}
?>