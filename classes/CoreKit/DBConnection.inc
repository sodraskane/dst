<?php
require_once($_SERVER["DOCUMENT_ROOT"]."/main/init.inc");
require_once($_SERVER["DOCUMENT_ROOT"]."/classes/CoreKit/exceptions/Y_IllegalValueException.inc");
require_once($_SERVER["DOCUMENT_ROOT"]."/classes/CoreKit/exceptions/Y_DBConnectionException.inc");
require_once($_SERVER["DOCUMENT_ROOT"]."/classes/CoreKit/exceptions/Y_SQLException.inc");
require_once($_SERVER["DOCUMENT_ROOT"]."/classes/CoreKit/ModifyResult.inc");
require_once($_SERVER["DOCUMENT_ROOT"]."/classes/CoreKit/SelectResult.inc");

/**
 *	Klassen DBConnection r en del av Y2-systemets abstraktionslager fr
 *	databashantering. Denna klass ska alltid anvndas nr ett php-script
 *	pratar med databasen. Alla anrop till en given databas sker genom en
 *	instans av klassen: en fr varje databas-server.
 *
 *	@version	Version 		0.2.1\n
 *				Skapad: 		2005-12-06\n
 *				Senast ndrad: 	2005-12-21
 *	@author 	Johan Holmberg, johan@yamborii.net
 */
class DBConnection {
	private $_username;   	// Login fr anslutning till servern
	private $_password;    	// Lsen fr anslutning till servern
	private $_hostname;    	// SQL-serverns placering
	private $_connection;  	// Koppling till databasservern
	private $_schema;		// Databasens namn

	/**
	 *	Skapar en instans av DBConnection. Inga parametrar r ndvndiga,
	 *	men gr att ge. Ges inga parametrar, kommer default-vrdena att
	 *	anvndas.
	 *
	 *	@throws Y_IllegalValueException om indatan var felaktig.
	 *
	 *	@param	$username r anvndarnamnet som anvnds fr att logga in p
	 *			databasservern. En strng.
	 *	@param	$password r lsenordet som anvnds fr att logga in p
	 *			databasservern. En strng.
	 *	@param	$hostname r vrddatorns adress. En strng.
	 *	@param	$schema r namnet p det databasschema vi vill anvnda. En strng.
	 */
	public function __construct($username = '', $password = '',
								$hostname = '', $schema = '') {
		if (!is_string($username))
			throw new Y_IllegalValueException('Expected a valid username');
		if (!is_string($password))
			throw new Y_IllegalValueException('Expected a valid password');
		if (!is_string($hostname))
			throw new Y_IllegalValueException('Expected a valid hostname');
		if (!is_string($schema))
			throw new Y_IllegalValueException('Expected a valid schema');
		
		global $_YINIT;
		
		if (strlen($username) > 0) {
			$this->_username = $username;
			$this->_password = $password;
			$this->_hostname = $hostname;
			$this->_schema = $schema;
		} else {
			$this->_username = $_YINIT['core_db_login'];
			$this->_password = $_YINIT['core_db_password'];
			$this->_hostname = $_YINIT['core_db_host'];
			$this->_schema = $_YINIT['core_db_database'];
		}
		$this->_connection = $this->_accessDB();
	}

	/**
	 *	Stnger kopplingen mot servern.
	 */
	public function __destruct() {
		//mysql_close();
	}
	
	/**
	 *	Skickar tillbaka namnet p databasservern.
	 *
	 *	@return	Returnerar servernamnet som en strng.
	 */
	public function getHostname() {
		return $this->_hostname;
	}
	
	/**
	 *	Skickar tillbaka namnet p aktuellt schema.
	 *
	 *	@return	Returnerar schemats namn som en strng.
	 */
	public function getSchema() {
		return $this->_schema;
	}
	
	/**
	 *	Skickar tillbaka kopplingen.
	 *
	 *	@return	Returnerar kopplingens id-nummer.
	 */
	public function getConnection() {
		return $this->_connection;
	}

	/**
	 *	Gr en frfrgan till databasen.\n
	 *
	 *	Kom ihg att kra addslashes() p alla strngar som ska skrivas
	 *	till databasen. Detta fr att frhindra SQL-injektioner.
	 *
	 *	@throws	Y_SQLException om frgan var ogilitig.
	 *
	 *	@param	$SQLQuery r en giltig SQL-frga.
	 *
	 *	@return Returnerar ett SQLResult-objekt. Detta objekt r egentligen
	 *			subklassat som SelectResult och ModifyResult, och vilket
	 *			objekt du fr, beror p vilken typ av frga du stllde.
	 */
	public function runQuery($SQLQuery) {
		$returnResult = null;
		$result = false;
		
		if (is_string($SQLQuery) && strlen(trim($SQLQuery)) > 0) {
			$SQLQuery = trim($SQLQuery);
			$result = mysql_query($SQLQuery, $this->_connection);
			if (!$result) {
				// Fel i frgan! Kasta undantag!
				throw new Y_SQLException('Illegal query!');
			} else if (is_resource($result)) {
				// En "select"-frga. Skapa ett SelectResult.
				$returnResult = new SelectResult($this, $SQLQuery, $result);
			} else {
				// En "modify"-frga. Skapa ett ModifyResult.
				$returnResult = new ModifyResult($this, $SQLQuery);
			}
		} else {
			throw new Y_SQLException('Illegal query!');
		}
		
		return $returnResult;
	}
	  
	  ############################################
	 #				Privata funktioner			#
	############################################
	  

	/**
	 *	Skapar en koppling till en MySQL-server.
	 *	@private
	 *
	 *	@throws Kastar ett Y_DBConnectionException om uppkopplingen misslyckades.
	 */
	private function _accessDB(){
		$result = null;    //Den resulterande SQL-kopplingen

		$result = mysql_pconnect($this->_hostname, $this->_username,
								 $this->_password);
		mysql_query('SET NAMES utf8');
		if (!$result)
			throw new Y_DBConnectionException("Unable to connect to server.");
		if (!mysql_select_db($this->_schema, $result))
			throw new Y_DBConnectionException("Unable to connect to server.");

		return $result;
	}
}
?>